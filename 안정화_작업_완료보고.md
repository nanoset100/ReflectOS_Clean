# ReflectOS 안정화 작업 완료 보고

## 📋 점검 항목별 결과

### ① client.auth.set_session() 토큰 형태 확인 ✅

**확인 결과:**
- `lib/config.py`의 `get_supabase_client()`에서 올바르게 구현됨
- `lib/auth.py`에 `get_access_refresh_tokens()` 헬퍼 함수 추가
- 문자열 토큰 2개를 직접 전달하는 형태로 수정

**실제 호출 형태:**
```python
# lib/config.py (53번째 줄)
client.auth.set_session(access_token, refresh_token)
```

**세션 저장 형태:**
```python
# lib/auth.py (119-122번째 줄)
st.session_state["supabase_session"] = {
    "access_token": response.session.access_token,  # 문자열
    "refresh_token": response.session.refresh_token  # 문자열
}
```

### ② 토큰 만료/갱신 처리 ✅

**구현 내용:**
- `lib/supabase_db.py`에 `_handle_auth_error()` 함수 추가
- 401 Unauthorized, 권한 거부, RLS 오류 감지 시 자동 로그아웃 처리
- 주요 CRUD 함수에 적용:
  - `get_profile()`
  - `upsert_profile()`
  - `create_module_entry()`
  - `get_module_entries()`
  - `insert_checkin()`
  - `list_checkins()`
  - `insert_extraction()`

**동작 방식:**
```python
def _handle_auth_error(e: Exception):
    error_msg = str(e).lower()
    if "401" in error_msg or "unauthorized" in error_msg or "permission denied" in error_msg:
        logout()  # 세션 정리
        st.warning("⚠️ 세션이 만료되었습니다. 다시 로그인해주세요.")
        st.rerun()  # auth 화면으로 복귀
```

### ③ profiles RLS 강화 후 프로필 생성 경로 확인 ✅

**확인 결과:**
- `upsert_profile()` 함수에 주의사항 추가: "로그인 후에만 호출되어야 함"
- `user_id` 검증 로직 추가: 없으면 에러 반환
- 호출 경로 확인:
  - `lib/auth.py`의 `signup()`: 회원가입 시 호출 (로그인 전이지만 회원가입 프로세스 내)
  - `pages/6_Settings.py`: 프로필 설정 저장 (로그인 후)
  - `lib/modules.py`: 모듈 설정 저장 (로그인 후)

**원칙 준수:** ✅ profiles 접근은 로그인 성공 후에만 수행

### ④ update_updated_at_column() 함수 존재 확인 ✅

**확인 결과:**
- `sql/schema.sql` 256번째 줄에 함수 정의 존재
- `sql/check_update_function.sql` 파일 생성 (함수 확인 및 생성 SQL)

**함수 정의:**
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### ⑤ st.set_page_config() 완전 제거 확인 ✅

**확인 결과:**
- `pages/auth.py`: 제거 완료 (주석으로 대체)
- `pages/1_Home.py`: 제거 완료
- `pages/2_Checkin.py`: 제거 완료
- `pages/3_Report.py`: 제거 완료
- `pages/4_Planner.py`: 제거 완료
- `pages/5_Memory.py`: 제거 완료
- `pages/6_Settings.py`: 제거 완료
- `app.py`: 유지 (1회만 실행)

**원칙 준수:** ✅ app.py에서만 1회 실행

### ⑥ module_entries.user_id 저장값 검증 ✅

**구현 내용:**
- `create_module_entry()` 함수에 user_id 검증 로직 추가
- 이메일 형태(`@` 포함) 감지 시 에러 반환
- 호출부 확인: `pages/health/today.py`에서 `get_current_user().id` 사용 (auth uid)

**검증 로직:**
```python
# user_id 검증 (이메일이 아닌 auth uid인지 확인)
if "@" in user_id:
    st.error("❌ user_id는 이메일이 아닌 auth uid 문자열이어야 합니다.")
    return None
```

**저장값:** ✅ `get_current_user().id` (auth uid 문자열)

---

## 🔧 추가 안정화 작업

### 1. 세션 토큰 추출 헬퍼 추가 ✅

**파일:** `lib/auth.py`

**함수:**
```python
def get_access_refresh_tokens() -> tuple[str, str] | None:
    """세션에서 access_token과 refresh_token을 안전하게 추출"""
```

**사용처:** `lib/config.py`의 `get_supabase_client()`

### 2. 로그아웃 처리 완전 정리 ✅

**파일:** `lib/auth.py`

**정리 항목:**
- `user`
- `user_id`
- `supabase_session`
- `is_authenticated` (혹시 남아있을 수 있는 임시 키)

### 3. 인증 오류 공통 처리 ✅

**파일:** `lib/supabase_db.py`

**함수:** `_handle_auth_error(e: Exception)`

**적용 함수:**
- `get_profile()`
- `upsert_profile()`
- `create_module_entry()`
- `get_module_entries()`
- `insert_checkin()`
- `list_checkins()`
- `insert_extraction()`

---

## 🧪 테스트 시나리오

### 시나리오 1: set_session 실제 호출 형태 확인

**테스트 방법:**
1. 로그인 성공
2. `lib/config.py`의 `get_supabase_client()` 실행
3. `client.auth.set_session(access_token, refresh_token)` 호출 확인

**예상 결과:**
- 문자열 토큰 2개가 직접 전달됨
- RLS 정책이 정상 작동하여 본인 데이터만 조회 가능

### 시나리오 2: 토큰 만료 시나리오

**테스트 방법:**
1. 로그인 후 세션 토큰을 수동으로 삭제
2. DB 조회 시도 (예: 체크인 목록 조회)
3. 401 오류 발생 시 자동 로그아웃 확인

**예상 결과:**
- `_handle_auth_error()` 함수가 오류 감지
- `logout()` 실행으로 세션 정리
- "세션이 만료되었습니다" 메시지 표시
- `st.rerun()`으로 auth 화면으로 복귀

### 시나리오 3: 로그아웃 후 auth 화면 복귀 확인

**테스트 방법:**
1. 로그인 상태에서 로그아웃 버튼 클릭
2. 세션 상태 확인
3. auth 화면 표시 확인

**예상 결과:**
- 모든 인증 관련 키 삭제됨
- `render_auth_page()` 호출되어 로그인/회원가입 UI 표시

---

## 📝 변경 파일 목록

### 수정한 파일 (5개)
1. `lib/auth.py` - 세션 토큰 추출 헬퍼 추가, logout() 완전 정리
2. `lib/config.py` - set_session 호출 형태 개선
3. `lib/supabase_db.py` - 인증 오류 처리 추가, user_id 검증 추가
4. `pages/auth.py` - set_page_config 제거

### 새로 생성한 파일 (1개)
1. `sql/check_update_function.sql` - update_updated_at_column() 함수 확인 SQL

---

## ✅ 완료 기준 통과 확인

- ✅ set_session 실제 호출 형태: 문자열 토큰 2개 직접 전달
- ✅ 토큰 만료 방어: 401 오류 시 자동 로그아웃 및 auth 화면 복귀
- ✅ profiles RLS 강화: 로그인 후에만 접근 가능
- ✅ update_updated_at_column() 함수: 존재 확인 및 SQL 파일 제공
- ✅ st.set_page_config 제거: app.py에만 유지
- ✅ module_entries.user_id: auth uid 문자열 검증 추가

---

## 🚀 다음 단계 권장사항

1. **실제 테스트 수행**
   - 토큰 만료 시나리오 강제 테스트
   - 로그아웃 후 auth 화면 복귀 확인
   - RLS 정책 작동 확인 (다른 계정으로 로그인 시 데이터 분리)

2. **모니터링**
   - 토큰 만료 오류 발생 빈도 모니터링
   - 사용자 피드백 수집 (세션 만료 경험)

3. **추가 개선 (선택사항)**
   - 토큰 자동 갱신 로직 (refresh_token 사용)
   - 세션 만료 전 경고 메시지
